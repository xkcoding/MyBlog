# Tasks: 统一博客图片托管至阿里云 OSS + SSL 证书管理优化

> **执行顺序调整**：由于 `static.xkcoding.com` 域名目前在七牛云使用，
> 需要先完成图片下载和上传，再切换域名，避免迁移期间图片无法访问。

## Phase 1A: 环境准备（先行）

- [ ] 1.1 创建阿里云 RAM 子账号
  - 登录阿里云控制台 → RAM 访问控制
  - 创建子账号，勾选「OpenAPI 调用访问」
  - 授予权限：DNS (alidns) + CDN + OSS
  - 创建并记录 AccessKey

- [ ] 1.2 配置 GitHub Secrets
  - `ALI_KEY`: 阿里云 AccessKey ID
  - `ALI_SECRET`: 阿里云 AccessKey Secret
  - `ACME_EMAIL`: 证书申请邮箱

- [ ] 1.5 安装配置 ossutil（本地）
  - 下载 ossutil 命令行工具
  - 使用 RAM 子账号的 AccessKey 配置
  - 验证连接到 OSS bucket

- [ ] 1.6 OSS Bucket 配置
  - 确认 Bucket 公开读权限
  - 配置跨域规则（CORS）允许博客域名访问

## Phase 1B: 域名切换（图片上传后执行）

- [ ] 1.3 开通并配置阿里云 CDN
  - 开通 CDN 服务（按流量计费）
  - **先在七牛云删除 `static.xkcoding.com` 域名**
  - 在阿里云 CDN 添加加速域名 `static.xkcoding.com`
  - 源站设置为 OSS: `xkcoding-blog.oss-cn-hangzhou.aliyuncs.com`
  - 记录 CDN 分配的 CNAME 地址

- [ ] 1.4 配置 DNS 解析
  - 在阿里云 DNS 添加/修改 CNAME 记录
  - `static` → CDN 分配的 CNAME 地址
  - 验证解析生效

## Phase 2: SSL 工作流优化（域名切换后执行）

- [ ] 2.1 创建 CDN SSL 证书工作流
  - 创建 `.github/workflows/cdn-ssl-renew.yml`
  - 使用 acme.sh + dns_ali 申请证书
  - 配置 deploy hook 部署到阿里云 CDN
  - 手动触发测试，验证证书申请成功

- [ ] 2.2 重构博客 SSL 证书工作流
  - 修改 `.github/workflows/ssl-manage.yml`
  - 从 HTTP-01 (certbot standalone) 改为 DNS-01 (acme.sh dns_ali)
  - 证书申请在 GitHub Actions 完成
  - 通过 SSH 部署证书到服务器 + reload nginx
  - 删除停止/启动 nginx 的逻辑

- [ ] 2.3 验证 SSL 工作流
  - 手动触发两个工作流
  - 验证 `https://xkcoding.com` 证书正常
  - 验证 `https://static.xkcoding.com` 证书正常

## Phase 3: 图片迁移脚本开发

- [ ] 3.1 创建图片扫描脚本
  - 扫描所有 Markdown 文件
  - 提取图片 URL（七牛云、阿里云旧域名、相对路径）
  - 生成图片清单 JSON 文件

- [ ] 3.2 创建图片下载脚本
  - 批量下载图片到本地临时目录
  - 保持原有路径结构
  - 记录下载失败的图片列表
  - 支持断点续传

- [ ] 3.3 创建 OSS 上传脚本
  - 使用 ossutil 批量上传图片
  - 保持路径结构一致
  - 生成上传报告

- [ ] 3.4 创建 URL 替换脚本
  - 生成新旧 URL 映射表
  - 预览替换结果（dry-run 模式）
  - 执行批量替换
  - 生成替换报告

## Phase 4: 执行图片迁移

- [ ] 4.1 下载七牛云图片（116 张）
  - 执行下载脚本
  - 检查下载完整性
  - 处理失败项

- [ ] 4.2 下载相对路径图片（8 张）
  - 从本地 hexo-backup 或网络下载
  - 如无法获取，标记为需手动处理

- [ ] 4.3 上传图片到 OSS
  - 批量上传所有图片
  - 验证上传成功
  - 记录最终 URL

- [ ] 4.4 更新 Markdown 文件
  - 执行 dry-run 预览变更
  - 确认无误后执行替换
  - 生成变更报告

## Phase 5: 验证与清理

- [ ] 5.1 验证图片可访问
  - 批量检查新 URL 返回 200
  - 记录任何 404 或错误

- [ ] 5.2 本地构建测试
  - 执行 `pnpm build`
  - 确认无图片加载错误

- [ ] 5.3 部署预发环境验证
  - 推送到 GitHub 触发 preview 部署
  - 手动检查页面图片显示

- [ ] 5.4 部署生产环境验证
  - 触发生产部署
  - 验证所有图片正常加载

- [ ] 5.5 清理临时文件
  - 删除本地下载的临时图片
  - 清理迁移脚本生成的中间文件

## 验收标准

**图片托管**：
- [ ] 所有博客图片从统一域名 `static.xkcoding.com` 加载
- [ ] 图片通过 HTTPS 访问，无混合内容警告
- [ ] 本地构建无 Shiki/图片相关警告
- [ ] 预发和生产环境图片正常显示

**SSL 证书管理**：
- [ ] `ssl-manage.yml` 使用 DNS-01 验证，零停机续期
- [ ] `cdn-ssl-renew.yml` 自动管理 CDN 证书
- [ ] 两个工作流都可手动触发和定时执行
- [ ] 证书续期不再需要停止 nginx

## 依赖关系（调整后）

```
Phase 1A (环境准备 - 先行)
1.1 ──▶ 1.2
1.1 ──▶ 1.5 ──▶ 3.3
1.6 ──▶ 3.3

Phase 3 (脚本开发) ← 当前阶段
3.1 ──▶ 3.2 ──▶ 3.3 ──▶ 3.4

Phase 4A (下载和上传)
3.2 ──▶ 4.1 ──┬──▶ 4.3
3.2 ──▶ 4.2 ──┘

Phase 1B (域名切换) ← 图片上传完成后
4.3 ──▶ 1.3 ──▶ 1.4

Phase 2 (SSL 优化) ← 域名切换后
1.4 ──▶ 2.1 ──▶ 2.3
1.2 ──▶ 2.2 ──▶ 2.3

Phase 4B (URL 替换)
1.4 ──▶ 4.4

Phase 5 (验证)
4.4 ──▶ 5.1 ──▶ 5.2 ──▶ 5.3 ──▶ 5.4
```

### 执行流程图

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Phase 1A + Phase 3: 环境准备 + 脚本开发                      │
│     （域名仍指向七牛云，图片可正常访问）                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  2. Phase 4A: 下载七牛云图片 → 上传到阿里云 OSS → 验证            │
│     （域名仍指向七牛云，双份图片保障）                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  3. Phase 1B: 七牛云删除域名 → 阿里云 CDN 添加 → DNS 切换         │
│     （切换窗口期，尽量快速完成）                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  4. Phase 2: 申请 SSL 证书，部署到 CDN                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  5. Phase 4B + 5: 更新 Markdown URL + 验证 + 清理                │
└─────────────────────────────────────────────────────────────────┘
```
