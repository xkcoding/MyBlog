---
title: ElasticSearch ç¬”è®°
comments: true
fancybox: true
toc: true
date: 2018-01-12 17:11:18
tags:
- elasticsearch
categories:
- elasticsearch
description:
permalink: elasticsearch_note
top:
---
`ElasticSearch`æ˜¯ä¸€ä¸ªåŸºäº `Lucene` çš„åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œä¸šå†…ç®€ç§°ESã€‚å®ƒæä¾›äº†åŸºäº `RESTful` é£æ ¼çš„å…¨æ–‡æœç´¢APIã€‚`Elasticsearch` æ˜¯ç”¨ `Java` å¼€å‘çš„ï¼Œå¹¶ä½œä¸º `Apache` è®¸å¯æ¡æ¬¾ä¸‹çš„å¼€æ”¾æºç å‘å¸ƒï¼Œæ˜¯å½“å‰æœ€æµè¡Œçš„ä¼ä¸šçº§æœç´¢å¼•æ“ã€‚å¦å¤–ï¼Œå®ƒçš„åˆ†å¸ƒå¼è®¾è®¡è®©å®ƒå¤©ç”Ÿå°±é€‚åˆç”¨äºäº‘è®¡ç®—ä¸­ï¼Œå¹¶èƒ½å¤Ÿè¾¾åˆ°å‡†å®æ—¶æœç´¢ï¼Œè€Œä¸”å®‰è£…ä½¿ç”¨æ–¹ä¾¿ï¼Œè¿˜æ‹¥æœ‰ç¨³å®šï¼Œå¯é ï¼Œå¿«é€Ÿç­‰ç‰¹æ€§ã€‚æœ¬æ–‡æ˜¯æˆ‘å¯¹ ES çš„ä¸€ä¸ªå®Œæ•´è®°å½•ï¼Œæ–¹ä¾¿åæœŸæŸ¥é˜…ã€‚å¦å¤–å¤§å®¶è¿˜å¯ä»¥æŸ¥é˜…æ›´å¤šçš„ç›¸å…³èµ„æ–™å¯¹ `ElasticSearch` æœ‰æ›´æ·±å…¥çš„äº†è§£ã€‚

<!--more-->

## å®‰è£…

### å•æœºå®‰è£…

> ElasticSearch è¦æ±‚æœ¬åœ°çš„ JDK ç‰ˆæœ¬ä¸ä½äº**1.8**

1. å»å®˜ç½‘ä¸‹è½½æœ€æ–°ç‰ˆçš„ ES è½¯ä»¶åŒ… https://www.elastic.co/downloads/elasticsearch ï¼Œç›®å‰ ES æœ€æ–°ç‰ˆæœ¬ä¸º6.1.1ï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨ wget å‘½ä»¤åœ¨ç»ˆç«¯ä¸‹è½½

   ```shell
   cd apps
   wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.1.1.tar.gz
   ```

2. å¦‚æœå‡ºç° `command not found: wget`ï¼Œå¦‚æœæ˜¯ Linuxï¼Œå¯ä»¥ç”¨ `yum install -y wget` ä¸‹è½½ï¼Œå¦‚æœæ˜¯ Mac å°±å¯ä»¥ç”¨ `brew install wget` ä¸‹è½½

3. æ£€æŸ¥æœ¬åœ° JDK ç‰ˆæœ¬ï¼Œå¿…é¡»ä¿è¯ä¸º**1.8**ç‰ˆæœ¬ä»¥ä¸Š

   ```shell
   $ java -version
   java version "1.8.0_131"
   Java(TM) SE Runtime Environment (build 1.8.0_131-b11)
   Java HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)
   ```

4. è§£å‹è½¯ä»¶åŒ…

   ```java
   tar -zxvf elasticsearch-6.1.1.tar.gz
   ```

5. å¯åŠ¨ ES

   ```shell
   cd elasticsearch-6.1.1
   ./bin/elasticsearch
   ```

6. æµ‹è¯•ï¼Œæ‰“å¼€ PostMan æµ‹è¯• http://localhost:9200 ï¼ŒæŸ¥çœ‹è¿”å›çš„ JSON ä¿¡æ¯

   ![PostManæµ‹è¯•å•æœºéƒ¨ç½²ç»“æœ](http://static.xkcoding.com/2018-01-12-15157443065618.jpg)

### åˆ†å¸ƒå¼å®‰è£…

è¿™é‡Œæˆ‘ä¼šåœ¨æœ¬åœ°å¯åŠ¨3ä¸ª ES èŠ‚ç‚¹ï¼Œåˆ†åˆ«ç”¨ä¸åŒçš„ç«¯å£å·æ¥æ¨¡æ‹Ÿåˆ†å¸ƒå¼çš„ç¯å¢ƒï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸º masterï¼Œå¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹ä¸º slave èŠ‚ç‚¹ã€‚

1. ä¸‹è½½å®‰è£…åŒ…ï¼Œè§£å‹3ä»½ï¼Œåˆ†åˆ«å‘½åä¸º `elasticsearch-master`ï¼Œ`elasticsearch-slave1`ï¼Œ`elasticsearch-slave2`

2. ä¿®æ”¹ `elasticsearch-master` çš„é…ç½®æ–‡ä»¶ï¼Œ`config/elasticsearch.yml`

   ```yaml
   http.cors.enabled: true
   http.cors.allow-origin: "*"

   ## ç”¨äºæŒ‡å®šé›†ç¾¤åç§°
   cluster.name: xkcoding
   ## ç”¨äºæŒ‡å®šèŠ‚ç‚¹åç§°
   node.name: master
   ## ç”¨äºæŒ‡å®šå½“å‰èŠ‚ç‚¹æ˜¯ master èŠ‚ç‚¹
   node.master: true

   network.host: 127.0.0.1
   http.port: 9200
   ```

3. ä¿®æ”¹ `elasticsearch-slave1` çš„é…ç½®æ–‡ä»¶ï¼Œ`config/elasticsearch.yml`

   ```yaml
   http.cors.enabled: true
   http.cors.allow-origin: "*"

   ## ç”¨äºæŒ‡å®šé›†ç¾¤åç§°
   cluster.name: xkcoding
   ## ç”¨äºæŒ‡å®šèŠ‚ç‚¹åç§°
   node.name: slave1

   network.host: 127.0.0.1
   http.port: 8200

   ## ç”¨äºå‘ç° master èŠ‚ç‚¹
   discovery.zen.ping.unicast.hosts: ["127.0.0.1"]
   ```

4. ä¿®æ”¹ `elasticsearch-slave2` çš„é…ç½®æ–‡ä»¶ï¼Œ`config/elasticsearch.yml`

   ```yaml
   http.cors.enabled: true
   http.cors.allow-origin: "*"

   ## ç”¨äºæŒ‡å®šé›†ç¾¤åç§°
   cluster.name: xkcoding
   ## ç”¨äºæŒ‡å®šèŠ‚ç‚¹åç§°
   node.name: slave2

   network.host: 127.0.0.1
   http.port: 7200

   ## ç”¨äºå‘ç° master èŠ‚ç‚¹
   discovery.zen.ping.unicast.hosts: ["127.0.0.1"]
   ```

5. å¯åŠ¨ head æ’ä»¶ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://localhost:9100ï¼ŒæŸ¥çœ‹åˆ†å¸ƒå¼èŠ‚ç‚¹çš„è¿è¡ŒçŠ¶æ€

   ![åˆ†å¸ƒå¼ ES çš„é›†ç¾¤çŠ¶æ€](http://static.xkcoding.com/2018-01-12-15157518741687.jpg)

### æ’ä»¶å®‰è£…

#### head æ’ä»¶

> head æ’ä»¶è¦æ±‚æœ¬åœ°çš„ Node ç‰ˆæœ¬ä¸ä½äº8.0

1. å‰å¾€ GitHub æœç´¢ `elasticsearch-head` ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºæ’ä»¶çš„ GitHub ä»“åº“åœ°å€ï¼Œhttps://github.com/mobz/elasticsearch-head ï¼Œclone æºä»£ç 

   ```shell
   cd ~/apps
   git clone https://github.com/mobz/elasticsearch-head.git
   ```

2. æ£€æŸ¥æœ¬åœ° Node ç‰ˆæœ¬ï¼Œå¿…é¡»ä¿è¯ä¸º**8.0**ç‰ˆæœ¬ä»¥ä¸Š

   ```shell
   $ node -v
   v8.5.0
   ```

3. ç¼–è¯‘ head æ’ä»¶

   ```shell
   cd ~/apps/elasticsearch-head
   npm install
   ```

   > å¦‚æœè§‰å¾—è¿™ä¸€æ­¥çš„ä¾èµ–ä¸‹è½½æ¯”è¾ƒæ…¢çš„è¯ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹å¼ï¼š
   >
   > 1. å¯ä»¥é€‰æ‹©ç§‘å­¦ä¸Šç½‘
   > 2. ä½¿ç”¨å›½å†…é˜¿é‡Œçš„é•œåƒæºï¼Œä½¿ç”¨ cnpm å®‰è£…ï¼Œå…·ä½“å¦‚ä½•é…ç½®ï¼Œæœ¬æ–‡ä¸åšèµ˜è¿°ã€‚å…·ä½“å‚è€ƒï¼šhttp://npm.taobao.org/

4. é…ç½® ES æ”¯æŒè·¨åŸŸè®¿é—®ï¼Œè®© head æ’ä»¶å¯ä»¥è®¿é—®åˆ°

   ```shell
   cd ~/apps/elasticsearch-6.1.1
   vim config/elasticsearch.yml
   ```

   æ·»åŠ è¿›ä¸‹é¢ä¸¤è¡Œå¯¹è·¨åŸŸçš„é…ç½®

   ```yaml
   http.cors.enabled: true
   http.cors.allow-origin: "*"
   ```

   ä¿å­˜ `:wq!` é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ ES

   ```shell
   ./bin/elasticsearch
   ```

5. è¿è¡Œ head æ’ä»¶

   ```shell
   cd ~/apps/elasticsearch-head
   npm run start
   ```

6. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://localhost:9100/ ï¼ŒæŸ¥çœ‹ head æ’ä»¶è¿è¡Œæ•ˆæœ

   ![è¿è¡Œ head æ’ä»¶ï¼ŒæŸ¥çœ‹å•æœº ES çŠ¶æ€](http://static.xkcoding.com/2018-01-12-15157472517495.jpg)

#### ik ä¸­æ–‡åˆ†è¯æ’ä»¶ï¼ˆæœ‰æ—¶é—´è¡¥å……ï¼‰

---

## åŸºç¡€æ¦‚å¿µ

### é›†ç¾¤å’ŒèŠ‚ç‚¹

æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª ES çš„å•ç‹¬å®ä¾‹ï¼Œé€šè¿‡ node_name æ¥æŒ‡å®šå„ä¸ªèŠ‚ç‚¹çš„åå­—ã€‚

é›†ç¾¤æ˜¯é€šè¿‡é…ç½®cluster_nameæ¥ä½¿å¾—èŠ‚ç‚¹æ‰¾åˆ°é›†ç¾¤ã€‚

### ç´¢å¼•

ç´¢å¼•æ˜¯å«æœ‰ç›¸åŒå±æ€§çš„æ–‡æ¡£é›†åˆï¼Œåœ¨ ES ä¸­æ˜¯é€šè¿‡ä¸€ä¸ªåå­—æ¥è¯†åˆ«çš„ï¼Œè€Œä¸”è¦æ±‚æ˜¯<span style="color:red">**è‹±æ–‡å­—æ¯å°å†™ä¸”ä¸åŒ…å«ä¸­åˆ’çº¿**</span>

ç´¢å¼•å¯¹åº”äº SQL çš„ database

### ç±»å‹

ç´¢å¼•å¯ä»¥å«æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªç±»å‹ï¼Œæ–‡æ¡£å¿…é¡»å±äºä¸€ä¸ªç±»å‹

ç±»å‹å¯¹åº”äº SQL çš„ table

### æ–‡æ¡£

æ–‡æ¡£æ˜¯å¯ä»¥è¢«ç´¢å¼•çš„åŸºæœ¬æ•°æ®å•ä½

æ–‡æ¡£å¯¹åº”äº SQL çš„ä¸€æ¡è®°å½•

### åˆ†ç‰‡

æ¯ä¸ªç´¢å¼•éƒ½æœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æ˜¯ä¸€ä¸ª Lucene ç´¢å¼•

### å¤‡ä»½

æ‹·è´ä¸€ä»½åˆ†ç‰‡å°±å®Œæˆäº†åˆ†ç‰‡çš„å¤‡ä»½

---

## åŸºæœ¬ç”¨æ³•

### è¯·æ±‚æ–¹å¼

API åŸºæœ¬æ ¼å¼ï¼š`http://<ip>:<port>/<ç´¢å¼•>/<ç±»å‹>/<æ–‡æ¡£ id>`

API è¯·æ±‚æ–¹å¼ï¼šGETã€POSTã€PUTã€DELETE

### ç´¢å¼•

#### åˆ›å»º

å‡è®¾åˆ›å»ºä¸€ä¸ª people çš„ç´¢å¼•ï¼Œæ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">PUT</span> æ–¹æ³•ï¼Œå°†ğŸ‘‡çš„ json æ”¾å…¥ Body è¯·æ±‚ä½“ï¼Œç‚¹å‡» Sendï¼Œè‹¥å‡ºç° `"acknowledged":true`ï¼Œåˆ™ä»£è¡¨ç´¢å¼•åˆ›å»ºæˆåŠŸã€‚

è¯·æ±‚ä½“çš„ json:

```json
{
	"settings":{
		"number_of_shards":3,
		"number_of_replicas":1
	},
	"mappings":{
		"person":{
			"properties":{
				"name":{
					"type":"text"
				},
				"age":{
					"type":"integer"
				},
				"country":{
					"type":"keyword"
				},
				"birthday":{
					"type":"date",
					"format":"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
				}
			}
		}
	}
}
```

{% note success %} 

**json è¯·æ±‚ä½“å­—æ®µè§£é‡Šï¼š**

1. settings å­—æ®µå¯ä»¥ä¸æŒ‡å®š
2. number_of_shards ä»£è¡¨åˆ†ç‰‡æ•°ï¼ˆé»˜è®¤ä¸º5ï¼‰
3. number_of_replicas ä»£è¡¨å¤‡ä»½æ•°ï¼ˆé»˜è®¤ä¸º1ï¼‰
4. text ç±»å‹çš„å­—æ®µæœç´¢æ—¶å°†ä¼šè¢«åˆ†è¯
5. keyword ç±»å‹çš„å­—æ®µæœç´¢æ—¶å°†ä¸ä¼šè¢«åˆ†è¯
6. epoch_millis ç±»å‹ä»£è¡¨æ—¶é—´æˆ³æ ¼å¼

{% endnote %}

è¿”å›å€¼ï¼š

```json
{
    "acknowledged": true,
    "shards_acknowledged": true,
    "index": "people"
}
```

å¦‚å›¾æ‰€ç¤ºï¼š

![åˆ›å»ºç´¢å¼•](http://static.xkcoding.com/2018-01-17-15161702463041.jpg)

#### åˆ é™¤

æ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">DELETE</span> æ–¹æ³•ï¼Œç‚¹å‡» Sendã€‚

è¿”å›å€¼ï¼š

```json
{
    "acknowledged": true
}
```

### æ’å…¥

ç°åœ¨æˆ‘ä»¬å‘ä¹‹å‰åˆ›å»ºçš„ç±»å‹ä¸­æ·»åŠ ä¸€æ¡æ–‡æ¡£è®°å½•ï¼Œæ’å…¥åˆ†ä¸º2ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯æŒ‡å®š IDï¼Œä¸€ç§æ˜¯ä¸æŒ‡å®š IDï¼Œå½“ä¸æŒ‡å®š ID æ—¶ï¼ŒID ç”± ES ç”Ÿæˆã€‚

#### æŒ‡å®š ID æ’å…¥

æ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people/person/1 ï¼Œå°†æ–‡æ¡£çš„ json æ”¾å…¥ Body è¯·æ±‚ä½“ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">PUT</span> æ–¹æ³•ï¼Œç‚¹å‡» Sendã€‚

æ–‡æ¡£å†…å®¹ï¼š

```json
{
	"name":"xkcoding",
	"age":24,
	"country":"ä¸­å›½",
	"birthday":"1994-11-22"
}
```

è¿”å›å€¼ï¼š

```json
{
    "_index": "people",
    "_type": "person",
    "_id": "1",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 2,
        "failed": 0
    },
    "_seq_no": 0,
    "_primary_term": 1
}
```

å¦‚å›¾æ‰€ç¤ºï¼š

![æŒ‡å®š id æ’å…¥](http://static.xkcoding.com/2018-01-17-15161719204773.jpg)

#### ä¸æŒ‡å®š ID æ’å…¥

æ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people/person ï¼Œå°†æ–‡æ¡£çš„ json æ”¾å…¥ Body è¯·æ±‚ä½“ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">POST</span> æ–¹æ³•ï¼Œç‚¹å‡» Sendã€‚

æ–‡æ¡£å†…å®¹ï¼š

```json
{
	"name":"ä¸­å¹´xkcoding",
	"age":34,
	"country":"ä¸­å›½",
	"birthday":"1984-11-22"
}
```

è¿”å›å€¼ï¼š

```json
{
    "_index": "people",
    "_type": "person",
    "_id": "I4_sAmEBVnl1iCRF78pG",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 2,
        "failed": 0
    },
    "_seq_no": 0,
    "_primary_term": 1
}
```

å¦‚å›¾æ‰€ç¤ºï¼š

![ä¸æŒ‡å®š id æ’å…¥](http://static.xkcoding.com/2018-01-17-15161725779321.jpg)

ç„¶åå‰å¾€ head æ’ä»¶æŸ¥çœ‹æ˜¯å¦æ’å…¥æ•°æ®


![head æ’ä»¶ä¸­æŸ¥çœ‹æ·»åŠ çš„æ–‡æ¡£è®°å½•](http://static.xkcoding.com/2018-01-17-15161727420397.jpg)

### ä¿®æ”¹

ä¿®æ”¹æ–‡æ¡£æ•°æ®ï¼Œæ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people/person/1/_update ï¼Œå°†è¯·æ±‚çš„ json æ”¾å…¥ Body è¯·æ±‚ä½“ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">POST</span> æ–¹æ³•ï¼Œç‚¹å‡» Sendã€‚

è¯·æ±‚ä½“ï¼š

```json
{
	"doc":{
		"name":"æ²ˆæ‰¬å‡¯"
	}
}
```

{% note danger %} 

æ³¨æ„ï¼šä¿®æ”¹çš„æ—¶å€™ URL å¿…é¡»åé¢è·Ÿ_updateï¼Œç„¶åè¦ä¿®æ”¹çš„å­—æ®µå¿…é¡»æ”¾åœ¨ doc å­—æ®µé‡Œã€‚

{% endnote%}

è¿”å›å€¼ï¼š

```json
{
    "_index": "people",
    "_type": "person",
    "_id": "1",
    "_version": 2,
    "result": "updated",
    "_shards": {
        "total": 2,
        "successful": 2,
        "failed": 0
    },
    "_seq_no": 1,
    "_primary_term": 1
}
```

å¦‚å›¾æ‰€ç¤ºï¼š

![ä¿®æ”¹æ–‡æ¡£](http://static.xkcoding.com/2018-01-17-15161741012942.jpg)

### åˆ é™¤

æ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people/1 ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">DELETE</span> æ–¹æ³•ï¼Œç‚¹å‡» Sendã€‚

è¿”å›å€¼ï¼š

```json
{
    "_index": "people",
    "_type": "person",
    "_id": "1",
    "_version": 3,
    "result": "deleted",
    "_shards": {
        "total": 2,
        "successful": 2,
        "failed": 0
    },
    "_seq_no": 2,
    "_primary_term": 1
}
```

### æŸ¥è¯¢

ES æ­£å¦‚å…¶åï¼Œæœ¬å°±æ˜¯ä¸ºäº† Search è€Œç”Ÿï¼Œæ‰€ä»¥æŸ¥è¯¢æ˜¯ ES æœ€ç‰›é€¼çš„åœ°æ–¹ã€‚ä½¿ç”¨ä¸Šé¢æåˆ°çš„æ’å…¥è¯­æ³•ï¼Œé¢„å…ˆæ’å…¥ä¸€å †åŸå§‹æ•°æ®ï¼Œç”¨ head æŸ¥çœ‹ã€‚

![é¢„å…ˆæ’å…¥çš„åŸå§‹æ•°æ®](http://static.xkcoding.com/2018-01-17-15161767712389.jpg)

#### ç®€å•æŸ¥è¯¢

æ‰“å¼€ PostManï¼Œè¾“å…¥åœ°å€ http://localhost:9200/people/person/1 ï¼Œå°†æ–¹æ³•æ”¹ä¸º <span style="color:red">GET</span> æ–¹æ³•ï¼Œç‚¹å‡» Sendã€‚

è¿”å› id ä¸º1çš„æ–‡æ¡£æ•°æ®ï¼š

```json
{
    "_index": "people",
    "_type": "person",
    "_id": "1",
    "_version": 1,
    "found": true,
    "_source": {
        "name": "xkcoding",
        "age": 24,
        "country": "ä¸­å›½",
        "birthday": "1994-11-22"
    }
}
```

#### æ¡ä»¶æŸ¥è¯¢

è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨ PostMan æ¥æµ‹è¯•æˆ‘ä»¬çš„æ¡ä»¶æŸ¥è¯¢

è¯·æ±‚åœ°å€ï¼šhttp://localhost:9200/people/_search

è¯·æ±‚æ–¹å¼ï¼šPOST

{% note danger %} 

è¿”å›å€¼å› ä¸ºæ–‡ç« ç¯‡å¹…æœ‰é™ï¼Œå°±ä¸å°†è¿”å›çš„å†…å®¹è´´åœ¨æ–‡ç« ä¸­äº†ï¼Œè¯·è‡ªè¡Œæµ‹è¯•ä¸‹æ–¹è¯·æ±‚ä½“ï¼ŒéªŒè¯ç»“æœ

{% endnote %}

1. æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£æ•°æ®

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"match_all":{}
   	}
   }
   ```

2. åˆ†é¡µæŸ¥è¯¢æ–‡æ¡£æ•°æ®ï¼Œç¬¬ 0 æ¡å¼€å§‹ï¼Œæ¯é¡µ 3 æ¡æ•°æ®

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"match_all":{}
   	},
   	"from":0,
   	"size":3
   }
   ```

3. æŸ¥è¯¢åå­—ä¸­åŒ…å«ã€Œå°ã€çš„æ–‡æ¡£

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"match":{
   			"name":"å°"
   		}
   	}
   }
   ```

4. æŸ¥è¯¢åå­—ä¸­åŒ…å«ã€Œå°ã€çš„æ–‡æ¡£ï¼Œå¹¶ä¸”æŒ‰ç…§ç”Ÿæ—¥é™åºæ’åº

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"match":{
   			"name":"å°"
   		}
   	},
   	"sort":[
   		{
   			"birthday":{
   				"order":"desc"
   			}
   		}
   	]
   }
   ```

#### èšåˆæŸ¥è¯¢

è¯·æ±‚åœ°å€ï¼šhttp://localhost:9200/people/_search

è¯·æ±‚æ–¹å¼ï¼šPOST

1. æŒ‰ç…§å¹´é¾„èšåˆæ•°æ®ï¼ŒæŸ¥å‡ºæ–‡æ¡£ä¸­ä¸åŒå¹´é¾„æ‰€å çš„äººæ•°

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"group_by_age":{
   			"terms":{
   				"field":"age"
   			}
   		}
   	}
   }
   ```

2. å¤šä¸ªèšåˆï¼Œåˆ†åˆ«æŒ‰ç…§å¹´é¾„ã€ç”Ÿæ—¥èšåˆæ•°æ®

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"group_by_age":{
   			"terms":{
   				"field":"age"
   			}
   		},
   		"group_by_birthday":{
   			"terms":{
   				"field":"birthday"
   			}
   		}
   	}
   }
   ```

3. å¹´é¾„æœ€å°

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"grades_ages":{
   			"min":{
   				"field":"age"
   			}
   		}
   	}
   }
   ```

4. å¹´é¾„æœ€å¤§

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"grades_ages":{
   			"max":{
   				"field":"age"
   			}
   		}
   	}
   }
   ```

5. å¹³å‡å¹´é¾„

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"grades_ages":{
   			"avg":{
   				"field":"age"
   			}
   		}
   	}
   }
   ```

6. å¹´é¾„æ€»å’Œ

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"grades_ages":{
   			"sum":{
   				"field":"age"
   			}
   		}
   	}
   }
   ```

7. ç»Ÿè®¡ï¼Œå°†3ã€4ã€5ã€6çš„ä¿¡æ¯ç»Ÿä¸€æŸ¥è¯¢

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"aggs":{
   		"grades_ages":{
   			"stats":{
   				"field":"age"
   			}
   		}
   	}
   }
   ```

---

## é«˜çº§æŸ¥è¯¢

### query

#### æ¨¡ç³ŠåŒ¹é…

æŸ¥è¯¢åå­—ä¸­åŒ…å«ã€Œå°ã€çš„æ–‡æ¡£

è¯·æ±‚ä½“ï¼š

```json
{
	"query":{
		"match":{
			"name":"å°"
		}
	}
}
```

#### è¯ç»„åŒ¹é…

æŸ¥è¯¢åå­—åªåŒ…å«ã€Œå°å‡¯ã€çš„æ–‡æ¡£ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨å¦‚ä¸‹çš„è¯·æ±‚ä½“æŸ¥è¯¢

```json
{
	"query":{
		"match":{
			"name":"å°å‡¯"
		}
	}
}
```

è¿”å›çš„ç»“æœï¼š

```json
// çœç•¥å…¶ä½™éƒ¨åˆ†
"hits": {
  "total": 3,
  "max_score": 1.8386619,
  "hits": [
    {
      "_index": "people",
      "_type": "person",
      "_id": "2",
      "_score": 1.8386619,
      "_source": {
        "name": "å¹´è½»çš„å°å‡¯",
        "age": 14,
        "country": "ä¸­å›½",
        "birthday": "2004-11-22"
      }
    },
    {
      "_index": "people",
      "_type": "person",
      "_id": "4",
      "_score": 0.8984401,
      "_source": {
        "name": "ç‹‚å°ç‹—",
        "age": 20,
        "country": "ä¸­å›½",
        "birthday": "1998-01-01"
      }
    },
    {
      "_index": "people",
      "_type": "person",
      "_id": "9",
      "_score": 0.8142733,
      "_source": {
        "name": "å°æ³½",
        "age": 32,
        "country": "æ—¥æœ¬",
        "birthday": "1986-02-02"
      }
    }
  ]
}
```

é€šè¿‡ç»“æœï¼Œå¯ä»¥å‘ç°ï¼Œé€šè¿‡ match å»æŸ¥è¯¢çš„æ—¶å€™ï¼ŒES è¿”å›çš„æ˜¯åˆ†åˆ«åŒ…å«ã€Œå°ã€ã€ã€Œå‡¯ã€çš„æ–‡æ¡£ï¼Œå¦‚ä½•å»æŸ¥è¯¢ name å­—æ®µåªåŒ…å«ã€Œå°å‡¯ã€çš„æ–‡æ¡£å‘¢ï¼Ÿä½¿ç”¨ **match_phrase** å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚

è¯·æ±‚ä½“ï¼š

```json
{
	"query":{
		"match_phrase":{
			"name":"å°å‡¯"
		}
	}
}
```

#### å­—æ®µæŸ¥è¯¢

æŸ¥è¯¢æ‰€æœ‰çš„ä¸­å›½äºº

è¯·æ±‚ä½“ï¼š

```json
{
	"query":{
		"term":{
			"country":"ä¸­å›½"
		}
	}
}
```

#### èŒƒå›´æŸ¥è¯¢ï¼ˆæ”¯æŒæ•°å€¼å‹å’Œæ—¥æœŸå‹ï¼‰

æŸ¥è¯¢å¹´é¾„ 24 â‰¤ ageï¼œ30 ç›´æ¥çš„æ•°æ®

è¯·æ±‚ä½“ï¼š

```json
{
	"query":{
		"range":{
			"age":{
				"gte":24,
				"lt":30
			}
		}
	}
}
```

### filter

{% note danger%}

ä¸€èˆ¬ç»“åˆ bool ä¸€èµ·ä½¿ç”¨ï¼Œ

{% endnote %}

æŸ¥è¯¢å¹´é¾„ä¸º23çš„æ–‡æ¡£æ•°æ®

è¯·æ±‚ä½“ï¼š

```json
{
	"query":{
		"bool":{
			"filter":{
				"term":{
					"age":23
				}
			}
		}
	}
}
```

### å¤åˆæ¡ä»¶æŸ¥è¯¢

#### å›ºå®šåˆ†æ•°æŸ¥è¯¢

1. æŸ¥è¯¢åå­—ä¸­åŒ…å«ã€Œå°ã€çš„æ–‡æ¡£ï¼Œå¹¶å›ºå®šæŸ¥è¯¢åˆ†æ•°

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"constant_score":{
   			"filter":{
   				"match":{
   					"name":"å°"
   				}
   			}
   		}
   	}
   }
   ```

2. æŸ¥è¯¢åå­—ä¸­åŒ…å«ã€Œå°ã€çš„æ–‡æ¡£ï¼Œå¹¶å›ºå®šæŸ¥è¯¢åˆ†æ•°ä¸º2

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"constant_score":{
   			"filter":{
   				"match":{
   					"name":"å°"
   				}
   			},
   			"boost":2
   		}
   	}
   }
   ```

#### å¸ƒå°”æŸ¥è¯¢

1. æŸ¥è¯¢æ˜¯å›½å®¶ä¸ºä¸­å›½æˆ–è€…å¹´é¾„ä¸º30çš„æ•°æ®

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"bool":{
   			"should":[
   				{
   					"match":{
   						"country":"ä¸­å›½"
   					}
   				},{
   					"match":{
   						"age":30
   					}
   				}	
   			]
   		}
   	}
   }
   ```

2. æŸ¥è¯¢å›½å®¶ä¸ºä¸­å›½å¹¶ä¸”å¹´é¾„ä¸º23çš„æ•°æ®

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"bool":{
   			"must":[
   				{
   					"match":{
   						"country":"ä¸­å›½"
   					}
   				},{
   					"match":{
   						"age":23
   					}
   				}	
   			]
   		}
   	}
   }
   ```

3. æŸ¥è¯¢å›½å®¶ä¸ºä¸­å›½å¹¶ä¸”å¹´é¾„ä¸º23å¹¶ä¸”ç”Ÿæ—¥æ¯”1995-07-01æ—©çš„æ•°æ®

   è¯·æ±‚ä½“ï¼š

   ```json
   {
   	"query":{
   		"bool":{
   			"must":[
   				{
   					"match":{
   						"country":"ä¸­å›½"
   					}
   				},{
   					"match":{
   						"age":23
   					}
   				}	
   			],
   			"filter":[{
   				"range":{
   					"birthday":{
   						"lt":"1995-07-01"
   					}
   				}
   			}]
   		}
   	}
   }
   ```

---

## Spring Boot é›†æˆ ES

{% note success %}

ä»£ç æ‰˜ç®¡åœ¨ GitHubï¼š[æˆ³æˆ‘è·å–æºç ](https://github.com/xkcoding/spring-boot-demo/tree/master/spring-boot-demo-elasticsearch)

{% endnote %}

### Spring Boot é›†æˆ ES çš„é…ç½®ç±»

åœ¨ Spring Boot ä¸­é…ç½®ç±»éœ€è¦ä½¿ç”¨ `@Configuration` æ¥æ ‡æ³¨

**application.yml**

```yaml
server:
  port: 8080
  context-path: /demo
elasticsearch:
  host: 127.0.0.1
  port: 9300
  cluster:
    name: xkcoding
```

**ElasticSearchConfig.java**

```java
package com.xkcoding.springbootdemoelasticsearch.config;

import org.elasticsearch.client.transport.TransportClient;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.transport.TransportAddress;
import org.elasticsearch.transport.client.PreBuiltTransportClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.net.InetAddress;
import java.net.UnknownHostException;

/**
 * <p>
 * ES çš„é…ç½®ç±»
 * </p>
 *
 * @package: com.xkcoding.springbootdemoelasticsearch.config
 * @descriptionï¼š ES çš„é…ç½®ç±»
 * @author: yangkai.shen
 * @date: Created in 2018/1/18 ä¸‹åˆ4:41
 * @copyright: Copyright (c) 2018
 * @version: 0.0.1
 * @modified: yangkai.shen
 */
@Configuration
public class ElasticSearchConfig {
	@Value("${elasticsearch.host}")
	private String host;

	@Value("${elasticsearch.port}")
	private int port;

	@Value("${elasticsearch.cluster.name}")
	private String clusterName;

	@Bean
	public TransportClient esClient() throws UnknownHostException {
		Settings settings = Settings.builder().put("cluster.name", this.clusterName).put("client.transport.sniff", true).build();

		TransportAddress master = new TransportAddress(InetAddress.getByName(host), port);
		TransportClient client = new PreBuiltTransportClient(settings).addTransportAddress(master);
		return client;
	}
}
```

### æ’å…¥

```java
/**
 * æ’å…¥ä¸€æ¡æ•°æ®åˆ° ES ä¸­ï¼Œid ç”± ES ç”Ÿæˆ
 *
 * @param name     åç§°
 * @param country  å›½ç±
 * @param age      å¹´é¾„
 * @param birthday ç”Ÿæ—¥
 * @return æ’å…¥æ•°æ®çš„ä¸»é”®
 */
@PostMapping("/person")
public ApiResponse add(@RequestParam String name,
                       @RequestParam String country,
                       @RequestParam Integer age,
                       @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") Date birthday) {
	try {
		XContentBuilder content = XContentFactory.jsonBuilder()
				.startObject()
				.field("name", name)
				.field("country", country)
				.field("age", age)
				.field("birthday", birthday.getTime())
				.endObject();

		IndexResponse response = esClient.prepareIndex(INDEX, TYPE).setSource(content).get();
		return ApiResponse.ofSuccess(response.getId());
	} catch (IOException e) {
		e.printStackTrace();
		return ApiResponse.ofStatus(Status.INTERNAL_SERVER_ERROR);
	}
}
```

### ä¿®æ”¹

```java
/**
 * æ ¹æ®ä¸»é”®ï¼Œä¿®æ”¹ä¼ é€’å­—æ®µå¯¹åº”çš„å€¼
 *
 * @param id       ES ä¸­çš„ id
 * @param name     å§“å
 * @param country  å›½ç±
 * @param age      å¹´é¾„
 * @param birthday ç”Ÿæ—¥
 * @return UPDATED ä»£è¡¨æ–‡æ¡£ä¿®æ”¹æˆåŠŸ
 */
@PutMapping("/person/{id}")
public ApiResponse update(@PathVariable String id, 
                          @RequestParam(value = "name", required = false) String name, 
                          @RequestParam(value = "country", required = false) String country, 
                          @RequestParam(value = "age", required = false) Integer age, 
                          @RequestParam(value = "birthday", required = false) @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") Date birthday) {
	UpdateRequest request = new UpdateRequest(INDEX, TYPE, id);
	try {
		XContentBuilder builder = XContentFactory.jsonBuilder().startObject();
		if (!Strings.isNullOrEmpty(name)) {
			builder.field("name", name);
		}
		if (!Strings.isNullOrEmpty(country)) {
			builder.field("country", country);
		}
		if (age != null && age > 0) {
			builder.field("age", age);
		}
		if (birthday != null) {
			builder.field("birthday", birthday.getTime());
		}
		builder.endObject();
		request.doc(builder);
	} catch (IOException e) {
		e.printStackTrace();
		return ApiResponse.ofStatus(Status.INTERNAL_SERVER_ERROR);
	}
	try {
		UpdateResponse response = esClient.update(request).get();
		return ApiResponse.ofSuccess(response);
	} catch (Exception e) {
		e.printStackTrace();
		return ApiResponse.ofStatus(Status.INTERNAL_SERVER_ERROR);
	}
}
```

### åˆ é™¤

```java
/**
 * æ ¹æ® id åˆ é™¤ ES çš„ä¸€æ¡è®°å½•
 *
 * @param id ES ä¸­çš„ id
 * @return DELETED ä»£è¡¨åˆ é™¤
 */
@DeleteMapping("/person/{id}")
public ApiResponse delete(@PathVariable String id) {
	DeleteResponse response = esClient.prepareDelete(INDEX, TYPE, id).get();
	return ApiResponse.ofSuccess(response.getResult());
}
```

### ç®€å•æŸ¥è¯¢

```java
/**
 * ç®€å•æŸ¥è¯¢ æ ¹æ® id æŸ¥ ES ä¸­çš„æ–‡æ¡£å†…å®¹
 *
 * @param id ES ä¸­å­˜å‚¨çš„ id
 * @return å¯¹åº” id çš„æ–‡æ¡£å†…å®¹
 */
@GetMapping("/person/{id}")
public ApiResponse get(@PathVariable String id) {
	GetResponse response = esClient.prepareGet(INDEX, TYPE, id).get();
	if (!response.isExists() || response.isSourceEmpty()) {
		return ApiResponse.ofStatus(Status.NOT_FOUND);
	}
	return ApiResponse.ofSuccess(response.getSource());
}
```

### å¤åˆæŸ¥è¯¢

```java
/**
 * å¤åˆæŸ¥è¯¢ï¼Œæ ¹æ®ä¼ è¿›æ¥çš„æ¡ä»¶ï¼ŒæŸ¥è¯¢å…·ä½“å†…å®¹
 *
 * @param name    æ ¹æ®å§“ååŒ¹é…
 * @param country æ ¹æ®å›½ç±åŒ¹é…
 * @param gtAge   å¤§äºå¹´é¾„
 * @param ltAge   å°äºå¹´é¾„
 * @return æ»¡è¶³æ¡ä»¶çš„æ–‡æ¡£å†…å®¹
 */
@PostMapping("/person/query")
public ApiResponse query(@RequestParam(value = "name", required = false) String name,
                         @RequestParam(value = "country", required = false) String country,
                         @RequestParam(value = "gt_age", defaultValue = "0") int gtAge,
                         @RequestParam(value = "lt_age", required = false) Integer ltAge) {
	BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();

	if (!Strings.isNullOrEmpty(name)) {
		boolQueryBuilder.must(QueryBuilders.matchQuery("name", name));
	}

	if (!Strings.isNullOrEmpty(country)) {
		boolQueryBuilder.must(QueryBuilders.matchQuery("country", country));
	}

	RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery("age").from(gtAge);

	if (ltAge != null && ltAge > 0) {
		rangeQueryBuilder.to(ltAge);
	}

	boolQueryBuilder.filter(rangeQueryBuilder);

	SearchRequestBuilder searchRequestBuilder = esClient.prepareSearch(INDEX)
			.setTypes(TYPE)
			.setSearchType(SearchType.DFS_QUERY_THEN_FETCH)
			.setQuery(boolQueryBuilder)
			.setFrom(0)
			.setSize(20);

	log.info("ã€queryã€‘:{}", searchRequestBuilder);

	SearchResponse searchResponse = searchRequestBuilder.get();
	List<Map<String, Object>> result = Lists.newArrayList();
	searchResponse.getHits().forEach(hit -> {
		result.add(hit.getSourceAsMap());
	});

	return ApiResponse.ofSuccess(result);
}
```

### æœç´¢å»ºè®®ï¼ˆæœ‰æ—¶é—´è¡¥å……ï¼‰

### èšåˆæŸ¥è¯¢ï¼ˆæœ‰æ—¶é—´è¡¥å……ï¼‰

## ç»“è¯­

ElasticSearch åœ¨ç°åœ¨æ˜¯ä¸€ä¸ªåº”ç”¨ååˆ†å¹¿æ³›ï¼Œä¸”ç«çƒ­çš„æŠ€æœ¯ï¼Œæœ¬æ–‡åªæ˜¯æˆ‘åœ¨å…¥é—¨ ES çš„ä¸€ç‚¹å°å°çš„è®°å½•ï¼Œæ›´å¤š ES çš„ä¸“ä¸šçŸ¥è¯†ï¼Œä¼˜åŒ–æŠ€å·§ï¼Œè¿˜éœ€è¦å¤§é‡çš„å­¦ä¹ ä¸å®è·µï¼

æ¨èå­¦ä¹ åœ°å€ï¼š

1. å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html
2. Elastic ä¸­æ–‡ç¤¾åŒºï¼šhttps://elasticsearch.cn/