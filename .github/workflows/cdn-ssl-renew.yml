name: CDN SSL Certificate Management

on:
  # æ¯æœˆ 1 å·å’Œ 15 å·å‡Œæ™¨ 4 ç‚¹æ‰§è¡Œï¼ˆé”™å¼€åšå®¢ SSL ç»­æœŸæ—¶é—´ï¼‰
  schedule:
    - cron: "0 20 1,15 * *" # UTC 20:00 = åŒ—äº¬æ—¶é—´ 04:00
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_renew:
        description: "å¼ºåˆ¶é‡æ–°ç”³è¯·è¯ä¹¦"
        required: false
        type: boolean
        default: false

env:
  DOMAIN: "cdn.xkcoding.com"
  EMAIL: "237497819@qq.com"

jobs:
  cdn-ssl-manage:
    runs-on: ubuntu-latest

    steps:
      - name: Install acme.sh
        run: |
          curl https://get.acme.sh | sh -s email=${{ env.EMAIL }}
          echo "$HOME/.acme.sh" >> $GITHUB_PATH

      - name: Configure Aliyun DNS API
        run: |
          export Ali_Key="${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
          export Ali_Secret="${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

          # ä¿å­˜åˆ° acme.sh è´¦æˆ·é…ç½®
          ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt

          # å†™å…¥çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "Ali_Key=${{ secrets.ALIYUN_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "Ali_Secret=${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}" >> $GITHUB_ENV

      - name: Issue/Renew Certificate
        run: |
          FORCE_RENEW="${{ github.event.inputs.force_renew }}"

          # æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶ç»­æœŸ
          FORCE_FLAG=""
          if [ "$FORCE_RENEW" = "true" ]; then
            echo "ðŸ”„ å¼ºåˆ¶é‡æ–°ç”³è¯·è¯ä¹¦..."
            FORCE_FLAG="--force"
          fi

          # ä½¿ç”¨ DNS-01 éªŒè¯ç”³è¯·/ç»­æœŸè¯ä¹¦
          echo "ðŸ” ç”³è¯·è¯ä¹¦: ${{ env.DOMAIN }}"
          ~/.acme.sh/acme.sh --issue \
            --dns dns_ali \
            -d ${{ env.DOMAIN }} \
            $FORCE_FLAG \
            --debug || {
              # å¦‚æžœè¯ä¹¦å·²å­˜åœ¨ä¸”æœªåˆ°æœŸï¼Œ--issue ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„
              echo "â„¹ï¸  è¯ä¹¦å¯èƒ½å·²å­˜åœ¨ä¸”æœªåˆ°æœŸ"
            }

      - name: Install Aliyun CLI
        run: |
          # ä¸‹è½½å¹¶å®‰è£…é˜¿é‡Œäº‘ CLI
          curl -Lo aliyun-cli.tgz https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli.tgz
          sudo mv aliyun /usr/local/bin/

          # é…ç½® CLI
          aliyun configure set \
            --profile default \
            --mode AK \
            --region cn-hangzhou \
            --access-key-id ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            --access-key-secret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: Deploy Certificate to CDN
        run: |
          CERT_PATH="$HOME/.acme.sh/${{ env.DOMAIN }}_ecc"

          # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
          if [ ! -f "$CERT_PATH/${{ env.DOMAIN }}.cer" ]; then
            # å°è¯•éž ECC è·¯å¾„
            CERT_PATH="$HOME/.acme.sh/${{ env.DOMAIN }}"
          fi

          if [ ! -f "$CERT_PATH/${{ env.DOMAIN }}.cer" ]; then
            echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la $HOME/.acme.sh/
            exit 1
          fi

          echo "ðŸ“œ è¯ä¹¦è·¯å¾„: $CERT_PATH"

          # è¯»å–è¯ä¹¦å†…å®¹ï¼ˆfullchain = è¯ä¹¦ + CA é“¾ï¼‰
          CERT_CONTENT=$(cat "$CERT_PATH/fullchain.cer")
          KEY_CONTENT=$(cat "$CERT_PATH/${{ env.DOMAIN }}.key")

          # ç”Ÿæˆè¯ä¹¦åç§°ï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
          CERT_NAME="cdn-xkcoding-$(date +%Y%m%d%H%M%S)"

          echo "ðŸš€ éƒ¨ç½²è¯ä¹¦åˆ° CDN..."
          echo "   è¯ä¹¦åç§°: $CERT_NAME"
          echo "   åŸŸå: ${{ env.DOMAIN }}"

          # ä½¿ç”¨é˜¿é‡Œäº‘ CDN API è®¾ç½®åŸŸåè¯ä¹¦ï¼ˆæ–°ç‰ˆ APIï¼‰
          aliyun cdn SetCdnDomainSSLCertificate \
            --DomainName ${{ env.DOMAIN }} \
            --CertName "$CERT_NAME" \
            --CertType upload \
            --SSLProtocol on \
            --SSLPub "$CERT_CONTENT" \
            --SSLPri "$KEY_CONTENT"

          echo "âœ… è¯ä¹¦éƒ¨ç½²æˆåŠŸï¼"

      - name: Verify HTTPS
        run: |
          echo "ðŸ” ç­‰å¾… CDN é…ç½®ç”Ÿæ•ˆ..."
          sleep 30

          echo "ðŸ” éªŒè¯ HTTPS è®¿é—®..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.DOMAIN }}/2017-07-12-14998277900006.jpg" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… HTTPS éªŒè¯æˆåŠŸï¼"
          else
            echo "âš ï¸  HTTPS è¿”å›žçŠ¶æ€ç : $HTTP_CODE"
            echo "   CDN å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´ç”Ÿæ•ˆï¼Œè¯·ç¨åŽæ‰‹åŠ¨éªŒè¯"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” CDN SSL è¯ä¹¦ç®¡ç†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸå**: \`${{ env.DOMAIN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å¼ºåˆ¶ç»­æœŸ**: ${{ github.event.inputs.force_renew || 'false' }}" >> $GITHUB_STEP_SUMMARY
