name: SSL Certificate Management

on:
  # æ¯æœˆ 1 å·å’Œ 15 å·å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
  schedule:
    - cron: "0 19 1,15 * *" # UTC 19:00 = åŒ—äº¬æ—¶é—´ 03:00
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  DOMAIN: xkcoding.com
  WWW_DOMAIN: www.xkcoding.com
  EMAIL: 237497819@qq.com
  CERT_PATH: /opt/myblog/certbot/etc/live/xkcoding.com

jobs:
  ssl-manage:
    runs-on: ubuntu-latest

    steps:
      - name: Manage SSL Certificate
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            set -e
            DOMAIN="xkcoding.com"
            WWW_DOMAIN="www.xkcoding.com"
            EMAIL="237497819@qq.com"
            CERT_PATH="/opt/myblog/certbot/etc/live/xkcoding.com"

            echo "ðŸ” æ£€æŸ¥ SSL è¯ä¹¦çŠ¶æ€..."

            # åˆ›å»ºå¿…è¦ç›®å½•
            mkdir -p /opt/myblog/dist
            mkdir -p /opt/myblog/certbot/etc
            mkdir -p /opt/myblog/certbot/var

            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
            if [ -d "$CERT_PATH" ]; then
              echo "ðŸ“œ è¯ä¹¦å·²å­˜åœ¨ï¼Œæ‰§è¡Œç»­æœŸæ£€æŸ¥..."

              # æ‰§è¡Œç»­æœŸ
              docker run --rm \
                -v /opt/myblog/certbot/etc:/etc/letsencrypt \
                -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
                -v /opt/myblog/dist:/var/www/html \
                certbot/certbot renew

              echo "âœ… è¯ä¹¦ç»­æœŸæ£€æŸ¥å®Œæˆ"

              # é‡å¯ nginx åŠ è½½æ–°è¯ä¹¦
              docker restart myblog-nginx 2>/dev/null || true

            else
              echo "ðŸ†• è¯ä¹¦ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆå§‹åŒ–ç”³è¯·..."

              # åœæ­¢æ‰€æœ‰å¯èƒ½å ç”¨ 80/443 ç«¯å£çš„å®¹å™¨
              echo "â¹ï¸  åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨..."
              docker stop myblog myblog-nginx nginx-temp 2>/dev/null || true
              docker rm myblog myblog-nginx nginx-temp 2>/dev/null || true

              # ç­‰å¾…ç«¯å£é‡Šæ”¾
              sleep 2

              # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
              echo "ðŸ” æ£€æŸ¥ç«¯å£çŠ¶æ€..."
              if ss -tlnp 2>/dev/null | grep -q ':80 '; then
                echo "âš ï¸  ç«¯å£ 80 ä»è¢«å ç”¨ï¼š"
                ss -tlnp 2>/dev/null | grep ':80 ' || true
                echo "å°è¯•å¼ºåˆ¶é‡Šæ”¾..."
                fuser -k 80/tcp 2>/dev/null || true
                sleep 2
              fi

              # ä½¿ç”¨ standalone æ¨¡å¼ç”³è¯·è¯ä¹¦ï¼ˆcertbot è‡ªå·±å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼‰
              echo "ðŸ“œ ä½¿ç”¨ standalone æ¨¡å¼ç”³è¯· Let's Encrypt è¯ä¹¦..."
              docker run --rm \
                -p 80:80 \
                -v /opt/myblog/certbot/etc:/etc/letsencrypt \
                -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
                certbot/certbot certonly \
                --standalone \
                --preferred-challenges http \
                --email "$EMAIL" \
                --agree-tos \
                --no-eff-email \
                -d "$DOMAIN" \
                -d "$WWW_DOMAIN"

              echo "âœ… è¯ä¹¦ç”³è¯·æˆåŠŸï¼"
              echo ""
              echo "âš ï¸  è¯·è¿è¡Œ Docker éƒ¨ç½²å·¥ä½œæµä»¥å¯ç”¨ HTTPS"
            fi

            # æ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯
            echo ""
            echo "ðŸ“œ å½“å‰è¯ä¹¦ä¿¡æ¯ï¼š"
            docker run --rm \
              -v /opt/myblog/certbot/etc:/etc/letsencrypt \
              -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
              certbot/certbot certificates || true

      - name: Summary
        run: |
          echo "## ðŸ” SSL è¯ä¹¦ç®¡ç†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡å™¨**: \`${{ secrets.ALIYUN_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸå**: xkcoding.com, www.xkcoding.com" >> $GITHUB_STEP_SUMMARY
