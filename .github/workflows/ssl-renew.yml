name: SSL Certificate Renew

on:
  # æ¯æœˆ 1 å·å’Œ 15 å·å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
  schedule:
    - cron: "0 19 1,15 * *" # UTC 19:00 = åŒ—äº¬æ—¶é—´ 03:00
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest

    steps:
      - name: Renew SSL Certificate
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            echo "ðŸ” å¼€å§‹æ£€æŸ¥ SSL è¯ä¹¦ç»­æœŸ..."

            # æ‰§è¡Œè¯ä¹¦ç»­æœŸ
            docker run --rm \
              -v /opt/myblog/certbot/etc:/etc/letsencrypt \
              -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
              -v /opt/myblog/dist:/var/www/html \
              certbot/certbot renew --quiet

            # æ£€æŸ¥ç»­æœŸç»“æžœ
            if [ $? -eq 0 ]; then
              echo "âœ… è¯ä¹¦æ£€æŸ¥/ç»­æœŸå®Œæˆ"

              # é‡å¯ nginx ä»¥åŠ è½½æ–°è¯ä¹¦
              docker restart myblog-nginx 2>/dev/null || true

              # æ˜¾ç¤ºè¯ä¹¦æœ‰æ•ˆæœŸ
              echo "ðŸ“œ å½“å‰è¯ä¹¦ä¿¡æ¯ï¼š"
              docker run --rm \
                -v /opt/myblog/certbot/etc:/etc/letsencrypt:ro \
                certbot/certbot certificates
            else
              echo "âŒ è¯ä¹¦ç»­æœŸå¤±è´¥"
              exit 1
            fi

      - name: Renewal Summary
        run: |
          echo "## ðŸ” SSL è¯ä¹¦ç»­æœŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡å™¨**: \`${{ secrets.ALIYUN_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸå**: xkcoding.com, www.xkcoding.com" >> $GITHUB_STEP_SUMMARY
