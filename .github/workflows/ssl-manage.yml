name: SSL Certificate Management

on:
  # æ¯æœˆ 1 å·å’Œ 15 å·å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
  schedule:
    - cron: "0 19 1,15 * *" # UTC 19:00 = åŒ—äº¬æ—¶é—´ 03:00
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_renew:
        description: "å¼ºåˆ¶é‡æ–°ç”³è¯·è¯ä¹¦"
        required: false
        type: boolean
        default: false

env:
  DOMAINS: "xkcoding.com www.xkcoding.com blog.xkcoding.com"
  EMAIL: "237497819@qq.com"
  SERVER_CERT_PATH: "/opt/myblog/certbot/etc/live/xkcoding.com"

jobs:
  ssl-manage:
    runs-on: ubuntu-latest

    steps:
      - name: Install acme.sh
        run: |
          curl https://get.acme.sh | sh -s email=${{ env.EMAIL }}
          echo "$HOME/.acme.sh" >> $GITHUB_PATH

      - name: Configure Aliyun DNS API
        run: |
          ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt

          # å†™å…¥çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "Ali_Key=${{ secrets.ALIYUN_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "Ali_Secret=${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}" >> $GITHUB_ENV

      - name: Issue/Renew Certificate
        run: |
          FORCE_RENEW="${{ github.event.inputs.force_renew }}"

          # æž„å»ºåŸŸåå‚æ•°
          DOMAIN_ARGS=""
          for domain in ${{ env.DOMAINS }}; do
            DOMAIN_ARGS="$DOMAIN_ARGS -d $domain"
          done

          # æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶ç»­æœŸ
          FORCE_FLAG=""
          if [ "$FORCE_RENEW" = "true" ]; then
            echo "ðŸ”„ å¼ºåˆ¶é‡æ–°ç”³è¯·è¯ä¹¦..."
            FORCE_FLAG="--force"
          fi

          # ä½¿ç”¨ DNS-01 éªŒè¯ç”³è¯·/ç»­æœŸè¯ä¹¦
          echo "ðŸ” ç”³è¯·è¯ä¹¦: ${{ env.DOMAINS }}"
          ~/.acme.sh/acme.sh --issue \
            --dns dns_ali \
            $DOMAIN_ARGS \
            $FORCE_FLAG \
            --debug || {
              # å¦‚æžœè¯ä¹¦å·²å­˜åœ¨ä¸”æœªåˆ°æœŸï¼Œ--issue ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„
              echo "â„¹ï¸  è¯ä¹¦å¯èƒ½å·²å­˜åœ¨ä¸”æœªåˆ°æœŸ"
            }

      - name: Deploy Certificate to Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            echo "ðŸš€ éƒ¨ç½²è¯ä¹¦åˆ°æœåŠ¡å™¨..."

            # åˆ›å»ºè¯ä¹¦ç›®å½•
            CERT_DIR="${{ env.SERVER_CERT_PATH }}"
            mkdir -p "$CERT_DIR"

            # è¯ä¹¦å°†é€šè¿‡ SCP ä¼ è¾“ï¼ˆä¸‹ä¸€æ­¥ï¼‰
            echo "âœ… è¯ä¹¦ç›®å½•å·²å‡†å¤‡: $CERT_DIR"

      - name: Prepare Certificate Files
        run: |
          CERT_PATH="$HOME/.acme.sh/xkcoding.com_ecc"

          # æ£€æŸ¥ ECC è¯ä¹¦è·¯å¾„
          if [ ! -f "$CERT_PATH/xkcoding.com.cer" ]; then
            CERT_PATH="$HOME/.acme.sh/xkcoding.com"
          fi

          if [ ! -f "$CERT_PATH/xkcoding.com.cer" ]; then
            echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la $HOME/.acme.sh/
            exit 1
          fi

          echo "ðŸ“œ è¯ä¹¦è·¯å¾„: $CERT_PATH"

          # åˆ›å»ºå·¥ä½œåŒºç›®å½•å­˜æ”¾è¯ä¹¦ï¼ˆSCP action å¯ä»¥è®¿é—®ï¼‰
          mkdir -p $GITHUB_WORKSPACE/certs

          # å¤åˆ¶è¯ä¹¦æ–‡ä»¶ï¼ˆä½¿ç”¨ certbot å…¼å®¹çš„æ–‡ä»¶åï¼‰
          cp "$CERT_PATH/xkcoding.com.cer" $GITHUB_WORKSPACE/certs/cert.pem
          cp "$CERT_PATH/xkcoding.com.key" $GITHUB_WORKSPACE/certs/privkey.pem
          cp "$CERT_PATH/fullchain.cer" $GITHUB_WORKSPACE/certs/fullchain.pem
          cp "$CERT_PATH/ca.cer" $GITHUB_WORKSPACE/certs/chain.pem 2>/dev/null || cp "$CERT_PATH/fullchain.cer" $GITHUB_WORKSPACE/certs/chain.pem

          echo "âœ… è¯ä¹¦æ–‡ä»¶å·²å‡†å¤‡"
          ls -la $GITHUB_WORKSPACE/certs/

      - name: Upload Certificate to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          source: "certs/*"
          target: "${{ env.SERVER_CERT_PATH }}/"
          strip_components: 1

      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            echo "ðŸ”„ é‡æ–°åŠ è½½ Nginx é…ç½®..."

            # æ£€æŸ¥è¯ä¹¦æ–‡ä»¶
            CERT_DIR="${{ env.SERVER_CERT_PATH }}"
            if [ -f "$CERT_DIR/fullchain.pem" ] && [ -f "$CERT_DIR/privkey.pem" ]; then
              echo "âœ… è¯ä¹¦æ–‡ä»¶å·²å°±ä½"
              ls -la "$CERT_DIR/"

              # é‡æ–°åŠ è½½ nginxï¼ˆæ— éœ€åœæ­¢æœåŠ¡ï¼‰
              docker exec myblog-nginx nginx -s reload 2>/dev/null || {
                echo "âš ï¸  Nginx reload å¤±è´¥ï¼Œå°è¯•é‡å¯å®¹å™¨..."
                docker restart myblog-nginx 2>/dev/null || true
              }

              echo "âœ… Nginx å·²é‡æ–°åŠ è½½è¯ä¹¦"
            else
              echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å®Œæ•´"
              ls -la "$CERT_DIR/" || true
              exit 1
            fi

      - name: Verify HTTPS
        run: |
          echo "ðŸ” ç­‰å¾…é…ç½®ç”Ÿæ•ˆ..."
          sleep 10

          echo "ðŸ” éªŒè¯ HTTPS è®¿é—®..."
          for domain in xkcoding.com www.xkcoding.com blog.xkcoding.com; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://$domain/" --max-time 10 || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "âœ… $domain: HTTPS æ­£å¸¸ (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸  $domain: HTTP $HTTP_CODE"
            fi
          done

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” SSL è¯ä¹¦ç®¡ç†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **éªŒè¯æ–¹å¼**: DNS-01 (Aliyun DNS)" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸå**: xkcoding.com, www.xkcoding.com, blog.xkcoding.com" >> $GITHUB_STEP_SUMMARY
          echo "- **å¼ºåˆ¶ç»­æœŸ**: ${{ github.event.inputs.force_renew || 'false' }}" >> $GITHUB_STEP_SUMMARY
