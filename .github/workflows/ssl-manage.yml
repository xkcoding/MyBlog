name: SSL Certificate Management

on:
  # æ¯æœˆ 1 å·å’Œ 15 å·å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
  schedule:
    - cron: "0 19 1,15 * *" # UTC 19:00 = åŒ—äº¬æ—¶é—´ 03:00
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_renew:
        description: "å¼ºåˆ¶é‡æ–°ç”³è¯·è¯ä¹¦ï¼ˆæ·»åŠ æ–°åŸŸåæ—¶ä½¿ç”¨ï¼‰"
        required: false
        type: boolean
        default: false

env:
  DOMAINS: "xkcoding.com,www.xkcoding.com,blog.xkcoding.com"
  EMAIL: 237497819@qq.com
  CERT_PATH: /opt/myblog/certbot/etc/live/xkcoding.com

jobs:
  ssl-manage:
    runs-on: ubuntu-latest

    steps:
      - name: Manage SSL Certificate
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          script: |
            set -e
            DOMAINS="xkcoding.com,www.xkcoding.com,blog.xkcoding.com"
            EMAIL="237497819@qq.com"
            CERT_PATH="/opt/myblog/certbot/etc/live/xkcoding.com"

            echo "ğŸ” æ£€æŸ¥ SSL è¯ä¹¦çŠ¶æ€..."
            echo "ğŸ“‹ åŸŸååˆ—è¡¨: $DOMAINS"

            # å¼ºåˆ¶é‡æ–°ç”³è¯·æ—¶åˆ é™¤æ—§è¯ä¹¦
            FORCE_RENEW="${{ github.event.inputs.force_renew }}"
            if [ "$FORCE_RENEW" = "true" ] && [ -d "$CERT_PATH" ]; then
              echo "ğŸ—‘ï¸  å¼ºåˆ¶æ¨¡å¼ï¼šåˆ é™¤æ—§è¯ä¹¦..."
              rm -rf /opt/myblog/certbot/etc/live/xkcoding.com
              rm -rf /opt/myblog/certbot/etc/archive/xkcoding.com
              rm -rf /opt/myblog/certbot/etc/renewal/xkcoding.com.conf
              echo "âœ… æ—§è¯ä¹¦å·²åˆ é™¤"
            fi

            # åˆ›å»ºå¿…è¦ç›®å½•
            mkdir -p /opt/myblog/dist
            mkdir -p /opt/myblog/certbot/etc
            mkdir -p /opt/myblog/certbot/var

            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
            if [ -d "$CERT_PATH" ]; then
              echo "ğŸ“œ è¯ä¹¦å·²å­˜åœ¨ï¼Œæ‰§è¡Œç»­æœŸæ£€æŸ¥..."

              # åœæ­¢ nginx é‡Šæ”¾ç«¯å£ 80ï¼ˆstandalone æ¨¡å¼ç»­æœŸéœ€è¦ï¼‰
              echo "â¹ï¸  åœæ­¢ nginx ä»¥é‡Šæ”¾ç«¯å£..."
              docker stop myblog-nginx 2>/dev/null || true

              # æ‰§è¡Œç»­æœŸï¼ˆstandalone æ¨¡å¼éœ€è¦ -p 80:80ï¼‰
              docker run --rm \
                -p 80:80 \
                -v /opt/myblog/certbot/etc:/etc/letsencrypt \
                -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
                certbot/certbot renew

              echo "âœ… è¯ä¹¦ç»­æœŸæ£€æŸ¥å®Œæˆ"

              # é‡å¯ nginx åŠ è½½æ–°è¯ä¹¦
              echo "ğŸš€ é‡å¯ nginx..."
              docker start myblog-nginx 2>/dev/null || true

            else
              echo "ğŸ†• è¯ä¹¦ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆå§‹åŒ–ç”³è¯·..."

              # åœæ­¢æ‰€æœ‰å¯èƒ½å ç”¨ 80/443 ç«¯å£çš„å®¹å™¨
              echo "â¹ï¸  åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨..."
              docker stop myblog myblog-nginx nginx-temp 2>/dev/null || true
              docker rm myblog myblog-nginx nginx-temp 2>/dev/null || true

              # ç­‰å¾…ç«¯å£é‡Šæ”¾
              sleep 2

              # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
              echo "ğŸ” æ£€æŸ¥ç«¯å£çŠ¶æ€..."
              if ss -tlnp 2>/dev/null | grep -q ':80 '; then
                echo "âš ï¸  ç«¯å£ 80 ä»è¢«å ç”¨ï¼š"
                ss -tlnp 2>/dev/null | grep ':80 ' || true
                echo "å°è¯•å¼ºåˆ¶é‡Šæ”¾..."
                fuser -k 80/tcp 2>/dev/null || true
                sleep 2
              fi

              # ä½¿ç”¨ standalone æ¨¡å¼ç”³è¯·è¯ä¹¦ï¼ˆcertbot è‡ªå·±å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼‰
              echo "ğŸ“œ ä½¿ç”¨ standalone æ¨¡å¼ç”³è¯· Let's Encrypt è¯ä¹¦..."

              # æ„å»ºåŸŸåå‚æ•°
              DOMAIN_ARGS=""
              IFS=',' read -ra DOMAIN_ARRAY <<< "$DOMAINS"
              for domain in "${DOMAIN_ARRAY[@]}"; do
                DOMAIN_ARGS="$DOMAIN_ARGS -d $domain"
              done

              docker run --rm \
                -p 80:80 \
                -v /opt/myblog/certbot/etc:/etc/letsencrypt \
                -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
                certbot/certbot certonly \
                --standalone \
                --preferred-challenges http \
                --email "$EMAIL" \
                --agree-tos \
                --no-eff-email \
                $DOMAIN_ARGS

              echo "âœ… è¯ä¹¦ç”³è¯·æˆåŠŸï¼"
              echo ""
              echo "âš ï¸  è¯·è¿è¡Œ Docker éƒ¨ç½²å·¥ä½œæµä»¥å¯ç”¨ HTTPS"
            fi

            # æ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯
            echo ""
            echo "ğŸ“œ å½“å‰è¯ä¹¦ä¿¡æ¯ï¼š"
            docker run --rm \
              -v /opt/myblog/certbot/etc:/etc/letsencrypt \
              -v /opt/myblog/certbot/var:/var/lib/letsencrypt \
              certbot/certbot certificates || true

      - name: Summary
        run: |
          echo "## ğŸ” SSL è¯ä¹¦ç®¡ç†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡å™¨**: \`${{ secrets.ALIYUN_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸå**: xkcoding.com, www.xkcoding.com, blog.xkcoding.com" >> $GITHUB_STEP_SUMMARY
