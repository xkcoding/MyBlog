---
title: "æ„‰å¿«çš„æœ¬åœ°å¼€å‘ä½“éªŒä¹‹æœ¬åœ°DNS"
author: xkcoding
pubDatetime: 2021-05-01T02:42:11.000Z
slug: happy-dev-run-local-dns-server
featured: false
draft: false
tags:
  - docker
  - dns
description: "æœ¬åœ°å¼€å‘æœåŠ¡å¤ªå¤šï¼Œip:port è®°ä¸ä½ï¼Ÿç”¨åŸŸåæ›¿ä»£ï¼æ–¹æ¡ˆä¸€ï¼šSwitchHosts ä¿®æ”¹ hosts æ–‡ä»¶ï¼Œç®€å•ä½†ä¸æ”¯æŒæ³›åŸŸåï¼›æ–¹æ¡ˆäºŒï¼šdnsmasq å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¸€è¡Œé…ç½®æ”¯æŒ *.dev.io æ³›åŸŸåè§£æï¼›æ–¹æ¡ˆä¸‰ï¼šgo-dnsmasq è§£å†³å†…å­˜æ³„æ¼é—®é¢˜ï¼Œé•œåƒä»… 2.7Mã€‚é™„ Docker Compose é…ç½® + M1 èŠ¯ç‰‡æœ¬åœ°ç¼–è¯‘æ•™ç¨‹ã€‚"
---

## å†™åœ¨å‰é¢

å¤§å®¶åœ¨æœ¬åœ°ç¯å¢ƒè¿›è¡Œè”è°ƒæˆ–è€…è¿è¡Œä¸€äº›æœåŠ¡çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯ç»å¸¸é€šè¿‡ `ip:port` è¿›è¡Œæµ‹è¯•ã€‚æœ‰æ—¶å€™æœåŠ¡ä¸€å¤šï¼Œç»å¸¸æ€§çš„éœ€è¦è®°ä½å¾ˆå¤š `ip:port` ä¿¡æ¯ã€‚

æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•é€šè¿‡è‡ªå®šä¹‰åŸŸåçš„æ–¹å¼å»æ›¿æ¢ `ip:port`ï¼Œå‡å»æˆ‘ä»¬çš„è®°å¿†è´Ÿæ‹…ï¼Œæå‡æˆ‘ä»¬çš„å¼€å‘ä½“éªŒã€‚

<!--more-->

## æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹æœ¬åœ° `Hosts` æ–‡ä»¶ + Nginx Proxy

è¿™é‡Œæ¨èä¸€æ¬¾å·¥å…·ï¼Œ[SwitchHosts](https://swh.app/zh/)ï¼ˆ_è®°å¿†ä¸­ï¼Œä¹‹å‰çš„ç‰ˆæœ¬å«åš `SwitchHosts!`_ï¼‰ï¼Œé¡µé¢ç®€æ´ï¼Œæ“ä½œä¸€ç›®äº†ç„¶ã€‚

é…ç½® Hosts æ–‡ä»¶ï¼Œåªéœ€è¦å°†åŸŸåçš„åœ°å€è·Ÿ IP åšæ˜ å°„å³å¯ã€‚
![SwitchHosts](https://cdn.xkcoding.com/2021/09/03/16305752555388.jpg?x-oss-process=style/tag_compress)

æµ‹è¯•

```bash
âœ  ~ ping a.dev.io
PING a.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.098 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.086 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.093 ms
^C
--- a.dev.io ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.086/0.101/0.118/0.012 ms
```

ä¿®æ”¹ Hosts æ–‡ä»¶è¿™ç§æ–¹å¼ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æœ¬æœºåˆéƒ¨ç½²äº†ä¸€ä¸ª b æœåŠ¡ï¼Œæ­¤æ—¶éœ€è¦åŠ ä¸€ä¸ª `b.dev.io`ï¼Œåˆ™éœ€è¦é¢å¤–æ–°å¢ä¸€æ¡è®°å½•ï¼Œå¹¶ä¸èƒ½åšåˆ°æ³›åŸŸåè§£æï¼ˆ`*.dev.io`ï¼‰ã€‚å¦‚æœè¦åœ¨æœ¬åœ°æ”¯æŒæ³›åŸŸåè§£æï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡æ–¹æ¡ˆäºŒæ¥å®ç°äº†ã€‚

## æ–¹æ¡ˆäºŒï¼šdnsmasq

åŸç”Ÿçš„ dnsmasq æ˜¯ä¸å…·å¤‡ç•Œé¢çš„ï¼Œè¿™é‡Œæ¨èä¸€æ¬¾å¸¦æœ‰ web ç•Œé¢çš„ `dnsmasq`ï¼ŒåŒæ—¶è¿˜æ”¯æŒã€ŒHot Reloadã€æœºåˆ¶ã€‚

æˆ‘ä»¬é€šè¿‡ docker å¿«é€Ÿå¯åŠ¨ä¸€ä¸ª dnsmasq æœåŠ¡ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ `dnsmasq.conf`ï¼Œå¹¶å°†é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ config ç›®å½•ä¸‹ã€‚

```ini
log-queries
no-resolv
server=8.8.8.8
server=114.114.114.114
strict-order

address=/dev.io/127.0.0.1
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `jpillora/dnsmasq:latest` è¿™ä¸ªé•œåƒï¼Œä¸‹é¢æ˜¯ç¼–æ’æ–‡ä»¶ï¼š

```yaml
version: "3.8"

services:
  dns-server:
    image: jpillora/dnsmasq:latest
    ports:
      - "53:53/udp"
      - 8080:8080
    environment:
      - HTTP_USER=root
      - HTTP_PASS=root
    volumes:
      - ./config/dnsmasq.conf:/etc/dnsmasq.conf
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
```

è¿è¡Œ `docker-compose up` å¯åŠ¨æœåŠ¡ï¼Œè®¿é—®ç®¡ç†ç•Œé¢ http://localhost:8080

![dnsmasqç®¡ç†ç•Œé¢](https://cdn.xkcoding.com/2021/09/03/16305767071171.jpg?x-oss-process=style/tag_compress)

æµ‹è¯•ï¼ˆè®°å¾—æŠŠæ–¹æ¡ˆä¸€çš„ Hosts è®°å½•é‡ç½®ä¸€ä¸‹ğŸ˜‰ï¼‰

```bash
âœ  ~ ping a.dev.io
ping: cannot resolve a.dev.io: Unknown host
```

å“¦è±ï¼Œå¤±è´¥äº†ï¼Œéœ€è¦ä¿®æ”¹æœ¬æœº DNS é…ç½®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š
![DNSé…ç½®](https://cdn.xkcoding.com/2021/09/03/16305773370388.jpg?x-oss-process=style/tag_compress)

å†æ¬¡æµ‹è¯•

```bash
âœ  ~ ping a.dev.io
PING a.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.043 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.044 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.133 ms
^C
--- a.dev.io ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.043/0.099/0.144/0.045 ms
```

æ­¤æ—¶ï¼Œå¦‚æœæµ‹è¯•ä¸€ä¸‹ `b.dev.io` å‘¢ï¼Ÿ

```bash
âœ  ~ ping b.dev.io
PING b.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.052 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.143 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.142 ms
^C
--- b.dev.io ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.052/0.112/0.143/0.043 ms
```

æ²¡é”™ï¼Œå¤©ç„¶æ”¯æŒæ³›åŸŸåè§£æï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢çš„é…ç½®ä¹ˆï¼Ÿ

```ini
address=/dev.io/127.0.0.1
```

è¿™é‡Œé…ç½®å°±æ„å‘³ç€ `*.dev.io` éƒ½ä¼šæŒ‡å‘åˆ° `127.0.0.1`ã€‚

## æ–¹æ¡ˆä¸‰ï¼šgo-dnsmasqï¼ˆ2021.09.16 æ›´æ–°ï¼‰

> è¿è¡Œäº†ä¸€æ®µæ—¶é—´æ–¹æ¡ˆäºŒä¹‹åï¼Œå‘ç°æˆ‘çš„ MBP è¶Šæ¥è¶Šå¡ï¼Œé€šè¿‡ docker stats å‘ç°å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ç»è¿‡æŠ˜è…¾ç¾¤ç¾¤ä¸»([è‹æ´‹](https://github.com/soulteary))çš„å»ºè®®ï¼Œæ›´æ¢äº†å¦å¤–ä¸€ä¸ª dns é•œåƒï¼Œå¯è§£å†³å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼ŒåŒæ—¶è‹å¤§è¿˜å¯¹è¯¥[é•œåƒ](https://github.com/soulteary/go-dnsmasq)è¿›è¡Œäº†ç²¾ç®€ï¼ˆé•œåƒå¤§å°çº¦2.7Mï¼‰ã€‚

æ–°å¢é…ç½®æ–‡ä»¶ `config/hosts.conf`

```ini
127.0.0.1 *.dev.io
```

åˆ›å»ºç¼–æ’æ–‡ä»¶

```yaml
version: "3.8"

services:
  dns-server:
    image: soulteary/go-dnsmasq:test
    command: dnsmasq -l 0.0.0.0:53 -f /hosts.conf -p 1s -n 114.114.114.114:53 -n 8.8.8.8:53
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    volumes:
      - ./config/hosts.conf:/hosts.conf:rw
    restart: unless-stopped
```

è¿è¡Œ `docker-compose up` å¯åŠ¨æœåŠ¡ï¼ŒåŒæ—¶åˆ«å¿˜äº†å‚è€ƒæ–¹æ¡ˆäºŒï¼Œéœ€è¦ä¿®æ”¹æœ¬æœº DNS é…ç½®ã€‚

æµ‹è¯•ä¸€ä¸‹ï¼š

```bash
âœ  ~ ping a.dev.io
PING a.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.049 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.084 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.162 ms
^C
--- a.dev.io ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.049/0.098/0.162/0.047 ms
âœ  ~ ping b.dev.io
PING b.dev.io (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.061 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.186 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.125 ms
^C
--- b.dev.io ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.061/0.124/0.186/0.051 ms
```

æ³›åŸŸåè§£æå·²ç»å¯ä»¥æ”¯æŒäº†ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ¡ˆè‡³å°‘ä¸ä¼šè®©æˆ‘çš„ç”µè„‘è¶Šç”¨è¶Šå¡ã€‚ğŸ˜

å¦‚æœæƒ³è¦çŸ¥é“ DNS çš„è§£ææ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡ `docker-compose logs -f` æŸ¥çœ‹ï¼Œå¦‚æœä½ ä¸æƒ³é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½® `Dozzle` æ¥æŸ¥çœ‹å®¹å™¨çš„æ—¥å¿—ï¼Œå…·ä½“ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒè‹å¤§çš„åšæ–‡ï¼šhttps://soulteary.com/2020/11/15/view-container-logs-in-realtime.html

### å°æ’æ›²

è‹å¤§å½“æ—¶æœªç¼–è¯‘ arm æ¶æ„çš„é•œåƒï¼Œå› æ­¤æˆ‘è¿™è¾¹ clone äº†æºç ï¼Œåœ¨æœ¬åœ°çš„ m1 èŠ¯ç‰‡çš„ç”µè„‘ä¸Šé‡æ–°ç¼–è¯‘äº†ä¸€ä¸ªæœ¬åœ°é•œåƒï¼Œæ‰€ä»¥å°ä¼™ä¼´ä»¬å¯ä»¥çœ‹åˆ°ä¸Šè¿°ç¼–æ’æ–‡ä»¶çš„é•œåƒ TAG ä¸º `soulteary/go-dnsmasq:test`ã€‚

å¦‚æœä¹Ÿæœ‰å°ä¼™ä¼´æ˜¯ m1 èŠ¯ç‰‡æƒ³è¦ä½“éªŒè¯¥é•œåƒçš„è¯ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„æ–¹æ¡ˆè¿›è¡Œæœ¬åœ°ç¼–è¯‘ã€‚

1. é¦–å…ˆ clone ä»“åº“åœ°å€ï¼Œ`git clone https://github.com/soulteary/go-dnsmasq.git`
2. ä¿®æ”¹ Dockfile å†…å®¹ï¼Œå°† upx æ³¨é‡Šä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```dockerfile
FROM golang:1.16-alpine AS Builder
WORKDIR /app
COPY . .
RUN go env -w GO111MODULE=on && \
    go env -w GOPROXY=https://mirrors.aliyun.com/goproxy/,direct && \
    go mod download
ARG VERSION=1.1.0
# RUN apk add upx
RUN go build -o dnsmasq -ldflags "-w -s -X main.Version=${VERSION}" -tags="netgo" -trimpath cmd/dnsmasq/main.go
# RUN upx -9 -o dnsmasq.min dnsmasq

FROM scratch
# COPY --from=Builder /app/dnsmasq.min /bin/dnsmasq
COPY --from=Builder /app/dnsmasq /bin/dnsmasq
ENV DNSMASQ_LISTEN=0.0.0.0:53
EXPOSE 53 53/udp
CMD ["/bin/dnsmasq"]
```

3. æ‰“åŒ…æœ¬åœ°é•œåƒ `docker build . -t soulteary/go-dnsmasq:test`

å¦å¤–ï¼Œç¾¤ä¸»å·²ç»ç­”åº”åé¢ä¼šæ›´æ–° arm æ¶æ„çš„é•œåƒå•¦ï¼Œå°ä¼™ä¼´ä»¬åé¢åº”è¯¥å¯ä»¥ç›´æ¥ä»å®˜æ–¹çš„é•œåƒä»“åº“ [soulteary/go-dnsmasq](https://hub.docker.com/r/soulteary/go-dnsmasq) æ‹‰å–ã€‚

---

ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥èŠèŠå¦‚æœé€šè¿‡ Traefik ä»£ç†æœ¬åœ°å®¹å™¨æœåŠ¡æ¥æå‡æœ¬åœ°çš„å¼€å‘ä½“éªŒã€‚

## å‚è€ƒ

- https://little-star.love/posts/f114e298/
- https://soulteary.com/2021/08/19/dns-for-local-development.html
