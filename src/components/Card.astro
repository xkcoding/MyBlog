---
import type { CollectionEntry } from "astro:content";
import { slugifyStr } from "@/utils/slugify";
import { getPath } from "@/utils/getPath";
import Datetime from "./Datetime.astro";

type Props = {
  variant?: "h2" | "h3";
} & CollectionEntry<"blog">;

const { variant: Heading = "h2", id, data, filePath, body } = Astro.props;

const { title, description, ...props } = data;

// 自动生成摘要：如果 description 为空，从文章内容提取
function getExcerpt(content: string, maxLength: number = 120): string {
  // 移除 frontmatter、HTML 标签、Markdown 语法
  const cleaned = content
    .replace(/---[\s\S]*?---/, "") // 移除 frontmatter
    .replace(/<!--more-->/g, "") // 移除 more 标记
    .replace(/<[^>]+>/g, "") // 移除 HTML 标签
    .replace(/!\[.*?\]\(.*?\)/g, "") // 移除图片
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1") // 保留链接文字
    .replace(/^#+\s+/gm, "") // 移除标题标记
    .replace(/[*_`~]/g, "") // 移除强调标记
    .replace(/>\s+/g, "") // 移除引用标记
    .replace(/\n+/g, " ") // 换行转空格
    .trim();

  if (cleaned.length <= maxLength) return cleaned;
  return cleaned.slice(0, maxLength).trim() + "...";
}

const excerpt = description || (body ? getExcerpt(body) : "");
---

<li class="my-6">
  <a
    href={getPath(id, filePath)}
    class:list={[
      "inline-block text-lg font-medium text-accent",
      "decoration-dashed underline-offset-4 hover:underline",
      "focus-visible:no-underline focus-visible:underline-offset-0",
    ]}
  >
    <Heading
      style={{ viewTransitionName: slugifyStr(title.replaceAll(".", "-")) }}
    >
      {title}
    </Heading>
  </a>
  <Datetime {...props} />
  {excerpt && <p class="text-foreground/80 mt-1 line-clamp-2">{excerpt}</p>}
</li>
