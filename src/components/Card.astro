---
import type { CollectionEntry } from "astro:content";
import { slugifyStr } from "@/utils/slugify";
import { getPath } from "@/utils/getPath";
import Datetime from "./Datetime.astro";

type Props = {
  variant?: "h2" | "h3";
  class?: string;
  "data-weight"?: string | number;
  style?: string;
  section?: string;
} & CollectionEntry<"blog">;

const {
  variant: Heading = "h2",
  id,
  data,
  filePath,
  body,
  class: className,
  "data-weight": dataWeight,
  style,
  section = "",
} = Astro.props;

const { title, description, featured, ogImage, ...props } = data;

// è§£æ ogImage URL
let ogImageUrl: string | undefined;
if (typeof ogImage === "string") {
  ogImageUrl = ogImage;
} else if (ogImage?.src) {
  ogImageUrl = ogImage.src;
}

// è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦ï¼šå¦‚æœ description ä¸ºç©ºï¼Œä»æ–‡ç« å†…å®¹æå–
function getExcerpt(content: string, maxLength: number = 350): string {
  // ç§»é™¤ frontmatterã€HTML æ ‡ç­¾ã€Markdown è¯­æ³•
  const cleaned = content
    .replace(/---[\s\S]*?---/, "") // ç§»é™¤ frontmatter
    .replace(/<!--more-->/g, "") // ç§»é™¤ more æ ‡è®°
    .replace(/<[^>]+>/g, "") // ç§»é™¤ HTML æ ‡ç­¾
    .replace(/!\[.*?\]\(.*?\)/g, "") // ç§»é™¤å›¾ç‰‡
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1") // ä¿ç•™é“¾æ¥æ–‡å­—
    .replace(/^#+\s+/gm, "") // ç§»é™¤æ ‡é¢˜æ ‡è®°
    .replace(/[*_`~]/g, "") // ç§»é™¤å¼ºè°ƒæ ‡è®°
    .replace(/>\s+/g, "") // ç§»é™¤å¼•ç”¨æ ‡è®°
    .replace(/\n+/g, " ") // æ¢è¡Œè½¬ç©ºæ ¼
    .trim();

  if (cleaned.length <= maxLength) return cleaned;
  return cleaned.slice(0, maxLength).trim() + "...";
}

const excerpt = description || (body ? getExcerpt(body) : "");
---

<li class:list={["my-6", className]} data-weight={dataWeight} style={style}>
  <div class="flex items-center gap-2">
    <a
      href={getPath(id, filePath)}
      class:list={[
        "inline-block text-lg font-medium text-accent",
        "decoration-dashed underline-offset-4 hover:underline",
        "focus-visible:no-underline focus-visible:underline-offset-0",
      ]}
    >
      <Heading
        style={{
          viewTransitionName: slugifyStr(section ? `${section}-${id}` : id),
        }}
      >
        {title}
      </Heading>
    </a>
    {
      featured && (
        <span class="featured-badge inline-flex shrink-0 items-center gap-0.5 rounded-full bg-gradient-to-r from-orange-500/20 to-red-500/20 px-2 py-0.5 text-xs font-medium text-orange-600 ring-1 ring-orange-500/30 dark:text-orange-400">
          <span class="animate-pulse">ğŸ”¥</span>
          æ¨è
        </span>
      )
    }
  </div>
  <Datetime {...props} />
  {
    excerpt && (
      <div
        class:list={[
          "mt-1 flex gap-4",
          { "flex-col sm:flex-row sm:items-start": ogImageUrl },
        ]}
      >
        {ogImageUrl && (
          <div class="group/thumb shrink-0 overflow-hidden rounded-md border border-foreground/10 shadow-sm">
            <img
              src={ogImageUrl}
              alt={title}
              width="160"
              height="96"
              class="h-24 w-full object-cover transition-transform duration-300 group-hover/thumb:scale-105 sm:h-24 sm:w-40"
              loading="lazy"
              decoding="async"
            />
          </div>
        )}
        <p
          class:list={[
            "min-w-0 flex-1 text-foreground/80",
            ogImageUrl ? "line-clamp-4" : "line-clamp-3",
          ]}
        >
          {excerpt}
        </p>
      </div>
    )
  }
</li>
